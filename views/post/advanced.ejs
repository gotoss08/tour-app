<% include ../partials/header_start.ejs %>
<link rel="stylesheet" href="/css/trix.css">
<script src="/js/trix.js"></script>
<% include ../partials/header_end.ejs %>

<div class="container mt-5 mb-5">
    <div class="row">
        <div class="col-12">
            <div class="text-muted mb-5">
                <h5>Поля, обозначенные <span style="font-size: 25pt;">*</span>, обязательны для заполнения</h5>
            </div>

            <form action="/post/new/advanced" method="post" id="post-form">
                <div id="accordion">
                    
                </div>
            </form>
        </div>
    </div>
    <hr>
    <div class="row mt-4">
        <div class="col-12 form-group">
            <button id="postSubmit" type="button" class="btn btn-success float-right" style="font-size: 16pt;"><%= __('post.submit') %></button>
        </div>
    </div>
</div>

<script type="text/javascript">

    /* Base accordion stuff */

    $('#postSubmit').click(() => {
        $('#post-form').submit();
    });

    const accordion = $('#accordion');

    addAccordionCard = (title, body, element=accordion, divide=false, cardHeaderClass='') => {
        let accordionChildCount = accordion.children().length;
        if (element != accordion) {
            accordionChildCount += element.children().length;
        }

        element.append(`
            ${divide ? '<hr>' : ''}
            <div class="card" ${accordionChildCount === 0 ? 'id="main-card"' : ''}>
                <div class="card-header ${cardHeaderClass}" id="heading${accordionChildCount+1}">
                    <h5 class="mb-0">
                        <a class="btn btn-outline" data-toggle="collapse" data-target="#collapse${accordionChildCount+1}">
                            ${title}
                        </a>
                    </h5>
                </div>

                <div id="collapse${accordionChildCount+1}" class="collapse ${accordionChildCount === 0 ? 'show' : ''}" data-parent="#${element.attr('id')}">
                    <div class="card-body">
                        ${body}
                    </div>
                </div>
            </div>
        `);
    };

    getDefaultTextarea = (name, placeholder='', required=false, id='') => {
        return `
            <div class="form-group">
                <input id="${id}" type="hidden" name="${name}">
                <trix-editor class="form-control post-body border-0" input="${id}" placeholder="${placeholder}"></trix-editor>
                <p><small class="text-muted"><%= __('post.body.editor.help') %></small></p>
            </div>
        `;
    };

    let introTitle = '* <%= __('post.title') %>';
    addAccordionCard(introTitle, `
        <div class="form-group">
            <select id="country-select" class="custom-select mr-1" name="country" required autofocus>
                <option value="" disabled selected hidden>* <%= __('post.country.select') %></option>
                <% for(var i = 0; i < countries.length; i++) { %>
                <% var country = countries[i]; %>
                <option value="<%= country._id %>"><%= __(country.name) %></option>
                <% } %>
            </select>
            <small id="post-country-select-error" class="form-text text-danger"></small>
        </div>
        <hr>

        <div class="form-group">
            <input type="text" class="form-control post-title border-0" id="post-title-main" name="title" placeholder="* <%= __('post.title.placeholder') %>" required autocomplete="off">
            <small id="post-title-main-error" class="form-text text-danger"></small>
        </div>
        <hr>

        <div class="form-group">
            <input id="body-input" type="hidden" name="body">
            <trix-editor id="post-body-main" class="form-control post-body border-0" input="body-input" placeholder="<%= __('post.body.placeholder') %>..."></trix-editor>
            <small id="post-body-main-error" class="form-text text-danger"></small>
            <p><small class="text-muted"><%= __('post.body.editor.help') %></small></p>
        </div>
    `, accordion, false, 'bg-warning');

    /* topics */

    const topics = [];

    <% for(var i = 0; i < topics.length; i++) { %>
        <% var topic = topics[i]; %>
        topics.push({ name: '<%= topic._id %>' , title: '<%= topic.name %>' });
    <% } %>

    topics.forEach(topic => addAccordionCard(topic.title, getDefaultTextarea(topic.name, topic.title + '...', false, topic.name)));

    // accordion.append('<div id="custom-topics"></div>');

    addAccordionCard('<%= __('post.topic.new') %>', `
        <div class="input-group mb-3">
            <input type="text" class="form-control" id="newTopicInput" placeholder="<%= __('post.new.topic.input.placeholder') %>">
            <div class="input-group-append">
                <button type="button" class="btn btn-outline-secondary" id="newTopicButton"><%= __('post.new.topic.button') %></button>
            </div>
        </div>

        <div id="accordion">
              <div id="custom-topics"></div>      
        </div>

    `, accordion, true, 'bg-success text-white');

    $('#newTopicButton').click(() => {
        const newTopicInput = $('#newTopicInput');

        if(newTopicInput.val()) {
            let newTopicName = newTopicInput.val();

            $.post('/post/topic/create_custom', { name: newTopicName }).done((topic) => {
                addAccordionCard(newTopicName, getDefaultTextarea(topic._id, newTopicName + '...', false, topic._id), $('#custom-topics'));

                $('#custom-topics').children('.card').children('.collapse').removeClass('show');
                $('#custom-topics').children('.card').last().children('.collapse').addClass('show');
            });

            newTopicInput.val('');
        }
    });

    /* votes */

    addAccordionCard('<%= __('post.vote.new') %>', `
        <div class="input-group">
            <input type="text" class="form-control" id="voteThemeInput" name="voteTheme" placeholder="<%= __('post.vote.theme.input.placeholder') %>">
        </div>
        <hr>
        <div class="input-group">
            <input type="text" class="form-control" id="addVoteOptionInput" placeholder="<%= __('post.vote.option.input.placeholder') %>">
            <div class="input-group-append">
                <button type="button" class="btn btn-outline-secondary" id="addVoteOptionButton"><%= __('post.vote.option.add.button') %></button>
            </div>
        </div>
        <hr>
        <div id="voteOptions">
            <div class="input-group mb-2">
                <input type="text" class="form-control" id="addVoteOptionInput" value="option 1" placeholder="<%= __('post.vote.option.input.placeholder') %>">
                <div class="input-group-append">
                    <button type="button" class="btn btn-outline-danger" id="addVoteOptionButton"><%= __('post.vote.option.remove.button') %></button>
                </div>
            </div>
        </div>
    `, accordion, true, 'bg-success text-white');

    removeVoteOption = (optionId) => {
        $('#' + optionId).remove();
    };

    addVoteOption = (optionValue, optionId, optionName) => {
        return `
            <div class="input-group mb-2">
                <input type="text" class="form-control" id="${optionId}" value="${optionValue}" placeholder="<%= __('post.vote.option.input.placeholder') %>">
                <div class="input-group-append">
                    <button type="button" class="btn btn-outline-danger" id="addVoteOptionButton" onclick="removeVoteOption(${optionId});"><%= __('post.vote.option.remove.button') %></button>
                </div>
            </div>
        `;
    };

    let voteOptions = $('#voteOptions');
</script>

<% include ../partials/editor_preparation.ejs %>
<% include ../partials/footer.ejs %>